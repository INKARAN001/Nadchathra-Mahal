<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Payment Transactions</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .admin-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
    }
    .table-container {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    .status-badge {
      font-size: 0.8em;
      padding: 0.4em 0.8em;
    }
    .loading-spinner {
      display: none;
    }
    .error-message {
      display: none;
      background: #f8d7da;
      color: #721c24;
      padding: 1rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
    }
    .card-number {
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }
    .refresh-btn {
      background: linear-gradient(45deg, #667eea, #764ba2);
      border: none;
      color: white;
      transition: transform 0.2s;
    }
    .refresh-btn:hover {
      transform: scale(1.05);
      color: white;
    }
    .table th {
      background: #f8f9fa;
      font-weight: 600;
      border: none;
    }
    .table td {
      vertical-align: middle;
      border-color: #e9ecef;
    }
    .table tbody tr:hover {
      background-color: #f8f9fa;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <div class="admin-container p-4">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 class="mb-1"><i class="bi bi-shield-check me-2"></i>Admin Dashboard</h2>
          <p class="text-muted mb-0">Manage payments, user requirements, and system data</p>
        </div>
        <div class="d-flex gap-2">
          <button id="refreshBtn" class="btn refresh-btn" onclick="loadAllData()">
            <i class="bi bi-arrow-clockwise me-1"></i>Refresh All
          </button>
          <a class="btn btn-outline-primary" href="/user-requirement.html">
            <i class="bi bi-person-plus me-1"></i>User Portal
          </a>
          <button id="logoutBtn" class="btn btn-outline-danger" onclick="logout()">
            <i class="bi bi-box-arrow-right me-1"></i>Logout
          </button>
        </div>
      </div>

      <!-- Login Status -->
      <div id="loginStatus" class="alert alert-info mb-4" style="display: none;">
        <i class="bi bi-info-circle me-2"></i>
        <span id="loginInfo"></span>
      </div>


      <!-- User Requirements Section -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="table-container">
            <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
              <h5 class="mb-0"><i class="bi bi-clipboard-data me-2"></i>User Requirements & Bookings</h5>
        <div>
            <button class="btn btn-sm btn-outline-success me-2" onclick="approveSelected()">
                <i class="bi bi-check-circle me-1"></i>Approve Selected
            </button>
            <button class="btn btn-sm btn-outline-danger me-2" onclick="rejectSelected()">
                <i class="bi bi-x-circle me-1"></i>Reject Selected
            </button>
            <button class="btn btn-sm btn-outline-primary me-2" onclick="refreshUserRequirements()">
                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
            </button>
            <button class="btn btn-sm btn-outline-info" onclick="forceRefresh()">
                <i class="bi bi-arrow-repeat me-1"></i>Force Refresh
            </button>
        </div>
            </div>
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Event Type</th>
                    <th>Event Date</th>
                    <th>Guests</th>
                    <th>Budget</th>
                    <th><i class="bi bi-utensils me-1"></i>Food Menu</th>
                    <th>Approval Status</th>
                    <th>Payment Status</th>
                    <th>Transaction ID</th>
                    <th>Submitted</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="userRequirementsTableBody">
                  <tr>
                    <td colspan="13" class="text-center py-4">
                      <div id="userRequirementsLoading" class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading user requirements...</p>
                      </div>
                      <div id="userRequirementsNoData" style="display: none;">
                        <i class="bi bi-inbox display-4 text-muted"></i>
                        <p class="text-muted mt-2">No user requirements found</p>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Error Message -->
      <div id="errorMessage" class="error-message">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <span id="errorText">Failed to load transactions. Please try again.</span>
      </div>

      <!-- Loading Spinner -->
      <div id="loadingSpinner" class="text-center py-4 loading-spinner">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Loading transactions...</p>
      </div>

      <!-- Transactions Table -->
      <div class="table-container">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th><i class="bi bi-hash me-1"></i>ID</th>
                <th><i class="bi bi-person me-1"></i>Name</th>
                <th><i class="bi bi-calendar-event me-1"></i>Event</th>
                <th><i class="bi bi-credit-card me-1"></i>Card Number</th>
                <th><i class="bi bi-calendar me-1"></i>Expiry</th>
                <th><i class="bi bi-shield me-1"></i>CVV</th>
                <th><i class="bi bi-flag me-1"></i>Status</th>
                <th><i class="bi bi-clock me-1"></i>Created At</th>
              </tr>
            </thead>
            <tbody id="transactionsTableBody">
              <tr>
                <td colspan="8" class="text-center text-muted py-4">
                  <i class="bi bi-hourglass-split me-2"></i>Loading transactions...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- No Data Message -->
      <div id="noDataMessage" class="text-center py-5" style="display: none;">
        <i class="bi bi-inbox display-1 text-muted"></i>
        <h4 class="text-muted mt-3">No transactions found</h4>
        <p class="text-muted">No payment transactions have been recorded yet.</p>
        <a href="/payment.html" class="btn btn-primary">
          <i class="bi bi-plus-circle me-1"></i>Create First Transaction
        </a>
      </div>
    </div>

    <!-- User Feedback Section -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="table-container">
          <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
            <h5 class="mb-0"><i class="bi bi-chat-dots me-2"></i>User Feedback</h5>
            <div>
              <button class="btn btn-sm btn-outline-primary me-2" onclick="refreshFeedback()">
                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
              </button>
              <button class="btn btn-sm btn-outline-info" onclick="loadFeedbackStats()">
                <i class="bi bi-graph-up me-1"></i>View Stats
              </button>
            </div>
          </div>
          
          <!-- Feedback Loading Spinner -->
          <div id="feedbackLoading" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading feedback...</p>
          </div>
          
          <!-- Feedback Table -->
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead>
                <tr>
                  <th><i class="bi bi-hash me-1"></i>ID</th>
                  <th><i class="bi bi-person me-1"></i>User ID</th>
                  <th><i class="bi bi-star me-1"></i>Rating</th>
                  <th><i class="bi bi-clock me-1"></i>Date</th>
                  <th><i class="bi bi-gear me-1"></i>Actions</th>
                </tr>
              </thead>
              <tbody id="feedbackTableBody">
                <tr>
                  <td colspan="12" class="text-center text-muted py-4">
                    <i class="bi bi-hourglass-split me-2"></i>Loading feedback...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- No Feedback Message -->
          <div id="feedbackNoData" class="text-center py-5" style="display: none;">
            <i class="bi bi-chat-dots display-4 text-muted"></i>
            <h4 class="text-muted mt-3">No feedback found</h4>
            <p class="text-muted">No user feedback has been submitted yet.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Feedback Statistics Modal -->
    <div class="modal fade" id="feedbackStatsModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-graph-up me-2"></i>Feedback Statistics</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="feedbackStatsContent">
              <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading statistics...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Feedback Modal -->
    <div class="modal fade" id="editFeedbackModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit Feedback</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="editFeedbackForm">
              <input type="hidden" id="editFeedbackId">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="editUserId" class="form-label">User ID</label>
                    <input type="text" class="form-control" id="editUserId" readonly>
                  </div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-12">
                  <div class="mb-3">
                    <label for="editRating" class="form-label">Rating</label>
                    <select class="form-select" id="editRating" required>
                      <option value="1">1 - Very Poor</option>
                      <option value="2">2 - Poor</option>
                      <option value="3">3 - Average</option>
                      <option value="4">4 - Good</option>
                      <option value="5">5 - Excellent</option>
                    </select>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveFeedbackChanges()">
              <i class="bi bi-check me-1"></i>Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let transactions = [];
    let userRequirements = [];
    let feedback = [];

    // Authentication check
    function checkAuthentication() {
      const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
      const userType = sessionStorage.getItem('userType');
      const username = sessionStorage.getItem('username');
      
      if (!isLoggedIn || userType !== 'admin') {
        alert('Access denied. Please login as admin first.');
        window.location.href = '/login.html';
        return false;
      }
      
      // Show login status
      const loginStatus = document.getElementById('loginStatus');
      const loginInfo = document.getElementById('loginInfo');
      loginStatus.style.display = 'block';
      loginInfo.innerHTML = `Welcome, <strong>${username}</strong>! | Logged in at: ${new Date(sessionStorage.getItem('loginTime')).toLocaleString()}`;
      
      return true;
    }

    function logout() {
      sessionStorage.removeItem('isLoggedIn');
      sessionStorage.removeItem('userType');
      sessionStorage.removeItem('username');
      sessionStorage.removeItem('loginTime');
      alert('Logged out successfully.');
      window.location.href = '/login.html';
    }

    function loadAllData() {
      loadTransactions();
      loadUserRequirements();
      loadFeedback();
    }

    function loadTransactions() {
      const loadingSpinner = document.getElementById('loadingSpinner');
      const errorMessage = document.getElementById('errorMessage');
      const tableBody = document.getElementById('transactionsTableBody');
      const noDataMessage = document.getElementById('noDataMessage');
      const refreshBtn = document.getElementById('refreshBtn');

      // Show loading state
      loadingSpinner.style.display = 'block';
      errorMessage.style.display = 'none';
      noDataMessage.style.display = 'none';
      refreshBtn.disabled = true;
      refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Loading...';

      // Use XMLHttpRequest instead of fetch to avoid "Failed to fetch" errors
      const xhr = new XMLHttpRequest();
      const timestamp = new Date().getTime();
      xhr.open('GET', `/api/payments?t=${timestamp}`, true);
      xhr.setRequestHeader('Accept', 'application/json');
      xhr.setRequestHeader('Cache-Control', 'no-cache');

      xhr.onload = function() {
        loadingSpinner.style.display = 'none';
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Refresh All';

        console.log('XHR Response status:', xhr.status);
        console.log('XHR Response text:', xhr.responseText);

        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            const data = JSON.parse(xhr.responseText);
            console.log('Received data from API:', data);
            transactions = data || [];
            displayTransactions();
            
            // Show success message briefly
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Updated!';
            refreshBtn.classList.add('btn-success');
            refreshBtn.classList.remove('btn-outline-primary');
            
            setTimeout(() => {
              refreshBtn.innerHTML = originalText;
              refreshBtn.classList.remove('btn-success');
              refreshBtn.classList.add('btn-outline-primary');
            }, 2000);
          } catch (error) {
            console.error('JSON parsing error:', error);
            showError('Failed to parse transaction data from server.');
          }
        } else {
          console.error('HTTP Error:', xhr.status, xhr.statusText);
          showError(`Failed to load transactions: Server responded with status ${xhr.status}`);
        }
      };

      xhr.onerror = function() {
        loadingSpinner.style.display = 'none';
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Refresh All';
        console.error('XHR Network error');
        showError('Network error. Could not connect to the server. Please check your connection.');
      };

      xhr.send();
    }

    function loadUserRequirements() {
      const loadingSpinner = document.getElementById('userRequirementsLoading');
      const noDataMessage = document.getElementById('userRequirementsNoData');
      const tableBody = document.getElementById('userRequirementsTableBody');

      // Show loading state
      loadingSpinner.style.display = 'block';
      noDataMessage.style.display = 'none';

      // Load from database using API with cache busting
      const xhr = new XMLHttpRequest();
      const timestamp = new Date().getTime();
      xhr.open('GET', `/api/user-requirements?t=${timestamp}`, true);
      xhr.setRequestHeader('Accept', 'application/json');
      xhr.setRequestHeader('Cache-Control', 'no-cache');

      xhr.onload = function() {
        loadingSpinner.style.display = 'none';
        console.log('User Requirements XHR Response status:', xhr.status);
        console.log('User Requirements XHR Response text:', xhr.responseText);

        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            userRequirements = JSON.parse(xhr.responseText);
            console.log('Loaded user requirements from database:', userRequirements);
            console.log('First requirement approval status:', userRequirements[0]?.approvalStatus);
            displayUserRequirements();
          } catch (error) {
            console.error('JSON parsing error:', error);
            noDataMessage.style.display = 'block';
          }
        } else {
          console.error('HTTP Error:', xhr.status, xhr.statusText);
          noDataMessage.style.display = 'block';
        }
      };

      xhr.onerror = function() {
        loadingSpinner.style.display = 'none';
        console.error('User Requirements XHR Network error');
        noDataMessage.style.display = 'block';
      };

      xhr.send();
    }

    function refreshUserRequirements() {
      loadUserRequirements();
    }

    function forceRefresh() {
      console.log('Force refreshing all data...');
      // Clear any cached data
      userRequirements = [];
      transactions = [];
      
      // Reload all data
      loadUserRequirements();
      loadTransactions();
      
      // Also try to clear browser cache
      if ('caches' in window) {
        caches.keys().then(function(names) {
          for (let name of names) {
            caches.delete(name);
          }
        });
      }
    }

    function displayTransactions() {
      const tableBody = document.getElementById('transactionsTableBody');
      const noDataMessage = document.getElementById('noDataMessage');

      console.log('Displaying transactions:', transactions.length);

      if (transactions.length === 0) {
        tableBody.innerHTML = '';
        noDataMessage.style.display = 'block';
        return;
      }

      noDataMessage.style.display = 'none';
      tableBody.innerHTML = '';

      // Sort by ID descending (newest first)
      const sortedTransactions = transactions.sort((a, b) => b.id - a.id);

      sortedTransactions.forEach(tx => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>#${tx.id}</strong></td>
          <td>${tx.name || '<span class="text-muted">N/A</span>'}</td>
          <td><span class="badge bg-info">${tx.eventName}</span></td>
          <td><span class="card-number">${maskCardNumber(tx.cardNumber)}</span></td>
          <td>${tx.expiryMonth}/${tx.expiryYear}</td>
          <td><span class="badge bg-secondary">${tx.cvv}</span></td>
          <td><span class="badge status-badge ${getStatusClass(tx.status)}">${tx.status}</span></td>
          <td><small class="text-muted">${formatDate(tx.createdAt)}</small></td>
        `;
        tableBody.appendChild(row);
      });
    }

    function displayUserRequirements() {
      const tableBody = document.getElementById('userRequirementsTableBody');
      const noDataMessage = document.getElementById('userRequirementsNoData');

      console.log('Displaying user requirements:', userRequirements.length);

      if (userRequirements.length === 0) {
        tableBody.innerHTML = '';
        noDataMessage.style.display = 'block';
        return;
      }

      noDataMessage.style.display = 'none';
      tableBody.innerHTML = '';

      // Sort by creation date descending (newest first)
      const sortedRequirements = userRequirements.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

      sortedRequirements.forEach((req, index) => {
        console.log(`Displaying requirement ${req.id} with approval status: ${req.approvalStatus}`);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input type="checkbox" class="requirement-checkbox" value="${req.id}"></td>
          <td><strong>${req.fullName || 'N/A'}</strong></td>
          <td><a href="mailto:${req.email}">${req.email || 'N/A'}</a></td>
          <td><span class="badge bg-info">${req.eventType || 'N/A'}</span></td>
          <td>${req.eventDate || 'N/A'}</td>
          <td><span class="badge bg-secondary">${req.guestCount || 'N/A'}</span></td>
          <td>${req.budget || 'N/A'}</td>
          <td>
            <div class="small">
              <div><strong>Standard:</strong> ${req.dietaryRestrictions ? (req.dietaryRestrictions.length > 30 ? req.dietaryRestrictions.substring(0, 30) + '...' : req.dietaryRestrictions) : 'Not selected'}</div>
              <div><strong>Premium:</strong> ${req.beveragePreferences ? (req.beveragePreferences.length > 30 ? req.beveragePreferences.substring(0, 30) + '...' : req.beveragePreferences) : 'None'}</div>
            </div>
          </td>
          <td><span class="badge status-badge ${getApprovalStatusClass(req.approvalStatus)}">${req.approvalStatus || 'PENDING'}</span></td>
          <td><span class="badge status-badge ${getStatusClass(req.paymentStatus)}">${req.paymentStatus || 'PENDING'}</span></td>
          <td><small class="text-muted">${req.transactionId || 'N/A'}</small></td>
          <td><small class="text-muted">${formatDate(req.createdAt)}</small></td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="viewRequirementDetails(${index})" title="View Details">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-sm btn-outline-success" onclick="contactUser('${req.email}')" title="Contact User">
              <i class="bi bi-envelope"></i>
            </button>
            ${req.approvalStatus === 'PENDING' ? `
              <button class="btn btn-sm btn-success me-1" onclick="approveRequirement(${req.id})" title="Approve">
                <i class="bi bi-check"></i>
              </button>
              <button class="btn btn-sm btn-danger me-1" onclick="rejectRequirement(${req.id})" title="Reject">
                <i class="bi bi-x"></i>
              </button>
            ` : ''}
            ${req.paymentStatus === 'COMPLETED' ? `
              <span class="badge bg-success">Payment Completed</span>
            ` : ''}
            ${req.paymentStatus === 'PENDING' && req.approvalStatus === 'APPROVED' ? `
              <button class="btn btn-sm btn-warning me-1" onclick="approvePayment(${req.id})" title="Approve Payment">
                <i class="bi bi-credit-card"></i> Approve Payment
              </button>
            ` : ''}
            <button class="btn btn-sm btn-outline-danger" onclick="deleteRequirement(${req.id})" title="Delete">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    function viewRequirementDetails(index) {
      const req = userRequirements[index];
      if (!req) return;

      const details = `
Name: ${req.fullName}
Email: ${req.email}
Phone: ${req.phone}
Date of Birth: ${req.dateOfBirth || 'Not provided'}
Event Type: ${req.eventType}
Event Date: ${req.eventDate}
Guest Count: ${req.guestCount}
Budget: ${req.budget}
Special Requirements: ${req.specialRequirements || 'None'}

--- FOOD MENU SELECTIONS ---
Standard Menu: ${req.dietaryRestrictions || 'Not selected'}
Premium Items: ${req.beveragePreferences || 'None'}
Food Notes: ${req.foodNotes || 'None'}

--- PAYMENT DETAILS ---
Card Holder: ${req.cardHolderName}
Card: ${maskCardNumber(req.cardNumber)}
Expiry: ${req.expiryMonth}/${req.expiryYear}
Payment Status: ${req.paymentStatus}
Transaction ID: ${req.transactionId || 'N/A'}
Amount: LKR ${formatLKR(req.amount || 50000.00)}

--- TIMESTAMPS ---
Created: ${formatDate(req.createdAt)}
Updated: ${formatDate(req.updatedAt)}
      `;
      
      alert(details);
    }

    function contactUser(email) {
      if (email && email !== 'N/A') {
        window.open(`mailto:${email}?subject=Regarding Your Event Booking at Nadchathra Mahal`);
      } else {
        alert('No email address available for this user.');
      }
    }


    function maskCardNumber(cardNumber) {
      if (!cardNumber || cardNumber.length < 4) return cardNumber;
      return '**** **** **** ' + cardNumber.slice(-4);
    }

    function getStatusClass(status) {
      switch (status) {
        case 'COMPLETED': return 'bg-success';
        case 'APPROVED': return 'bg-success';
        case 'FAILED': return 'bg-danger';
        case 'PENDING': return 'bg-warning text-dark';
        case 'PROCESSING': return 'bg-info';
        case 'CANCELLED': return 'bg-secondary';
        case 'REFUNDED': return 'bg-primary';
        default: return 'bg-light text-dark';
      }
    }

    function getApprovalStatusClass(status) {
      switch (status) {
        case 'APPROVED': return 'bg-success';
        case 'REJECTED': return 'bg-danger';
        case 'PENDING': return 'bg-warning text-dark';
        default: return 'bg-light text-dark';
      }
    }

    // Payment approval function - admin can approve after user completes payment
    function approvePayment(requirementId) {
      if (!confirm('Are you sure you want to approve this payment? This action cannot be undone.')) {
        return;
      }

      const xhr = new XMLHttpRequest();
      xhr.open('PUT', `/api/user-requirements/${requirementId}/payment-status?paymentStatus=COMPLETED&transactionId=${Date.now()}`, true);
      xhr.setRequestHeader('Content-Type', 'application/json');

      xhr.onload = function() {
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            const response = JSON.parse(xhr.responseText);
            if (response.status === 'SUCCESS') {
              alert('Payment approved successfully! User will be notified.');
              // Refresh the data to show updated status
              loadUserRequirements();
              loadTransactions();
            } else {
              alert('Error: ' + response.message);
            }
          } catch (error) {
            console.error('JSON parsing error:', error);
            alert('Payment approved successfully! (Response parsing error)');
            loadUserRequirements();
            loadTransactions();
          }
        } else {
          console.error('HTTP Error:', xhr.status, xhr.statusText);
          alert('Error approving payment. Please try again.');
        }
      };

      xhr.onerror = function() {
        console.error('Network error approving payment');
        alert('Network error. Please check your connection and try again.');
      };

      xhr.send();
    }

    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAll');
      const checkboxes = document.querySelectorAll('.requirement-checkbox');
      
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
      });
    }

    function approveSelected() {
      const selectedCheckboxes = document.querySelectorAll('.requirement-checkbox:checked');
      if (selectedCheckboxes.length === 0) {
        alert('Please select at least one requirement to approve.');
        return;
      }

      if (confirm(`Are you sure you want to approve ${selectedCheckboxes.length} requirement(s)?`)) {
        selectedCheckboxes.forEach(checkbox => {
          approveRequirement(parseInt(checkbox.value));
        });
      }
    }

    function rejectSelected() {
      const selectedCheckboxes = document.querySelectorAll('.requirement-checkbox:checked');
      if (selectedCheckboxes.length === 0) {
        alert('Please select at least one requirement to reject.');
        return;
      }

      const reason = prompt(`Please provide a reason for rejecting ${selectedCheckboxes.length} requirement(s):`);
      if (reason !== null) {
        selectedCheckboxes.forEach(checkbox => {
          rejectRequirement(parseInt(checkbox.value), reason);
        });
      }
    }

    function approveRequirement(requirementId) {
        if (confirm(`Are you sure you want to approve requirement ${requirementId}?`)) {
            const xhr = new XMLHttpRequest();
            xhr.open('PUT', `/api/user-requirements/${requirementId}/approve`, true);
            xhr.setRequestHeader('Accept', 'application/json');

            xhr.onload = function() {
                if (xhr.status >= 200 && xhr.status < 300) {
                    console.log('Approval successful, refreshing data...');
                    alert(`Requirement ${requirementId} approved successfully!`);
                    // Force refresh the data
                    setTimeout(() => {
                        loadUserRequirements();
                    }, 500);
                } else {
                    console.error('Approval failed:', xhr.status, xhr.responseText);
                    alert(`Failed to approve requirement ${requirementId}. Status: ${xhr.status}. Response: ${xhr.responseText}`);
                }
            };

            xhr.onerror = function() {
                alert(`Network error while approving requirement ${requirementId}. Please try again.`);
            };

            xhr.send();
        }
    }

    function rejectRequirement(requirementId, reason = '') {
        const rejectionReason = prompt(`Please provide a reason for rejecting requirement ${requirementId}:`, reason);
        if (rejectionReason !== null) {
            const xhr = new XMLHttpRequest();
            xhr.open('PUT', `/api/user-requirements/${requirementId}/reject?reason=${encodeURIComponent(rejectionReason)}`, true);
            xhr.setRequestHeader('Accept', 'application/json');

            xhr.onload = function() {
                if (xhr.status >= 200 && xhr.status < 300) {
                    console.log('Rejection successful, refreshing data...');
                    alert(`Requirement ${requirementId} rejected successfully!`);
                    // Force refresh the data
                    setTimeout(() => {
                        loadUserRequirements();
                    }, 500);
                } else {
                    console.error('Rejection failed:', xhr.status, xhr.responseText);
                    alert(`Failed to reject requirement ${requirementId}. Status: ${xhr.status}. Response: ${xhr.responseText}`);
                }
            };

            xhr.onerror = function() {
                alert(`Network error while rejecting requirement ${requirementId}. Please try again.`);
            };

            xhr.send();
        }
    }

    function deleteRequirement(requirementId) {
        if (confirm(`Are you sure you want to delete requirement ${requirementId}? This action cannot be undone.`)) {
            const xhr = new XMLHttpRequest();
            xhr.open('DELETE', `/api/user-requirements/${requirementId}`, true);
            xhr.setRequestHeader('Accept', 'application/json');

            xhr.onload = function() {
                if (xhr.status >= 200 && xhr.status < 300) {
                    alert(`Requirement ${requirementId} deleted successfully!`);
                    loadUserRequirements(); // Refresh the list
                } else {
                    console.error('Deletion failed:', xhr.status, xhr.responseText);
                    alert(`Failed to delete requirement ${requirementId}. Status: ${xhr.status}. Response: ${xhr.responseText}`);
                }
            };

            xhr.onerror = function() {
                alert(`Network error while deleting requirement ${requirementId}. Please try again.`);
            };

            xhr.send();
        }
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      try {
        const date = new Date(dateString);
        return date.toLocaleString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (error) {
        return dateString;
      }
    }

    function formatLKR(amount) {
      return new Intl.NumberFormat('en-LK', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(amount);
    }

    function showError(message) {
      const errorMessage = document.getElementById('errorMessage');
      const errorText = document.getElementById('errorText');
      errorText.textContent = message;
      errorMessage.style.display = 'block';
    }

    // Auto-refresh every 30 seconds
    setInterval(loadAllData, 30000);

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Page loaded, checking authentication...');
      
      // Check authentication first
      if (checkAuthentication()) {
        console.log('Authentication successful, loading data...');
        loadAllData();
      }
    });

    // Also load on window focus (when user comes back to tab)
    // Feedback Functions
    function loadFeedback() {
      const loadingSpinner = document.getElementById('feedbackLoading');
      const noDataMessage = document.getElementById('feedbackNoData');
      const tableBody = document.getElementById('feedbackTableBody');

      // Show loading state
      loadingSpinner.style.display = 'block';
      noDataMessage.style.display = 'none';

      // Load from database using API with cache busting
      const xhr = new XMLHttpRequest();
      const timestamp = new Date().getTime();
      xhr.open('GET', `/api/user-feedback?t=${timestamp}`, true);
      xhr.setRequestHeader('Accept', 'application/json');
      xhr.setRequestHeader('Cache-Control', 'no-cache');

      xhr.onload = function() {
        loadingSpinner.style.display = 'none';
        console.log('Feedback XHR Response status:', xhr.status);
        console.log('Feedback XHR Response text:', xhr.responseText);

        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            feedback = JSON.parse(xhr.responseText);
            console.log('Loaded feedback from database:', feedback);
            displayFeedback();
          } catch (error) {
            console.error('JSON parsing error:', error);
            noDataMessage.style.display = 'block';
          }
        } else {
          console.error('HTTP Error:', xhr.status, xhr.statusText);
          noDataMessage.style.display = 'block';
        }
      };

      xhr.onerror = function() {
        loadingSpinner.style.display = 'none';
        console.error('Feedback XHR Network error');
        noDataMessage.style.display = 'block';
      };

      xhr.send();
    }

    function displayFeedback() {
      const tableBody = document.getElementById('feedbackTableBody');
      const noDataMessage = document.getElementById('feedbackNoData');

      console.log('Displaying feedback:', feedback.length);

      if (feedback.length === 0) {
        tableBody.innerHTML = '';
        noDataMessage.style.display = 'block';
        return;
      }

      noDataMessage.style.display = 'none';
      tableBody.innerHTML = '';

      // Sort by creation date descending (newest first)
      const sortedFeedback = feedback.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

      sortedFeedback.forEach((fb, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${fb.id || 'N/A'}</strong></td>
          <td><strong>${fb.userId || 'N/A'}</strong></td>
          <td><span class="badge ${getRatingClass(fb.rating)}">${fb.rating || 'N/A'}/5</span></td>
          <td><small class="text-muted">${formatDate(fb.createdAt)}</small></td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="editFeedback(${fb.id})" title="Edit Feedback">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteFeedback(${fb.id})" title="Delete Feedback">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    function getRatingClass(rating) {
      if (!rating) return 'bg-light text-dark';
      if (rating >= 4) return 'bg-success';
      if (rating >= 3) return 'bg-warning text-dark';
      return 'bg-danger';
    }

    function refreshFeedback() {
      loadFeedback();
    }

    function loadFeedbackStats() {
      const modal = new bootstrap.Modal(document.getElementById('feedbackStatsModal'));
      const content = document.getElementById('feedbackStatsContent');
      
      // Show loading state
      content.innerHTML = `
        <div class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Loading statistics...</p>
        </div>
      `;
      
      modal.show();

      // Load feedback statistics
      const xhr = new XMLHttpRequest();
      xhr.open('GET', '/api/user-feedback/stats', true);
      xhr.setRequestHeader('Accept', 'application/json');

      xhr.onload = function() {
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            const stats = JSON.parse(xhr.responseText);
            displayFeedbackStats(stats);
          } catch (error) {
            console.error('Error parsing feedback stats:', error);
            content.innerHTML = '<div class="alert alert-danger">Error loading statistics</div>';
          }
        } else {
          console.error('Error loading feedback stats:', xhr.status);
          content.innerHTML = '<div class="alert alert-danger">Error loading statistics</div>';
        }
      };

      xhr.onerror = function() {
        content.innerHTML = '<div class="alert alert-danger">Network error loading statistics</div>';
      };

      xhr.send();
    }

    function displayFeedbackStats(stats) {
      const content = document.getElementById('feedbackStatsContent');
      
      content.innerHTML = `
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title"><i class="bi bi-chat-dots me-2"></i>Total Feedback</h6>
                <h3 class="text-primary">${stats.totalFeedbacks || 0}</h3>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title"><i class="bi bi-star me-2"></i>Average Rating</h6>
                <h3 class="text-warning">${stats.averageRating || 0}/5</h3>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function editFeedback(feedbackId) {
      const feedback = feedbacks.find(fb => fb.id === feedbackId);
      if (!feedback) {
        alert('Feedback not found');
        return;
      }

      // Populate the edit form
      document.getElementById('editFeedbackId').value = feedback.id;
      document.getElementById('editUserId').value = feedback.userId || '';
      document.getElementById('editRating').value = feedback.rating || '';

      // Show the modal
      const modal = new bootstrap.Modal(document.getElementById('editFeedbackModal'));
      modal.show();
    }

    function saveFeedbackChanges() {
      const feedbackId = document.getElementById('editFeedbackId').value;
      const formData = {
        userId: parseInt(document.getElementById('editUserId').value),
        rating: parseInt(document.getElementById('editRating').value)
      };

      console.log('Updating feedback:', feedbackId, formData);

      const xhr = new XMLHttpRequest();
      xhr.open('PUT', `/api/user-feedback/${feedbackId}`, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.setRequestHeader('Accept', 'application/json');

      xhr.onload = function() {
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            const response = JSON.parse(xhr.responseText);
            if (response.status === 'SUCCESS') {
              alert('Feedback updated successfully!');
              // Close modal
              const modal = bootstrap.Modal.getInstance(document.getElementById('editFeedbackModal'));
              modal.hide();
              // Refresh feedback list
              loadFeedback();
            } else {
              alert('Error updating feedback: ' + response.message);
            }
          } catch (error) {
            console.error('Error parsing response:', error);
            alert('Error updating feedback. Please try again.');
          }
        } else {
          console.error('Error updating feedback:', xhr.status, xhr.responseText);
          alert('Error updating feedback. Status: ' + xhr.status);
        }
      };

      xhr.onerror = function() {
        alert('Network error while updating feedback. Please try again.');
      };

      xhr.send(JSON.stringify(formData));
    }

    function deleteFeedback(feedbackId) {
      if (confirm(`Are you sure you want to delete feedback ${feedbackId}? This action cannot be undone.`)) {
        const xhr = new XMLHttpRequest();
        xhr.open('DELETE', `/api/user-feedback/${feedbackId}`, true);
        xhr.setRequestHeader('Accept', 'application/json');

        xhr.onload = function() {
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              const response = JSON.parse(xhr.responseText);
              if (response.status === 'SUCCESS') {
                alert('Feedback deleted successfully!');
                // Refresh feedback list
                loadFeedback();
              } else {
                alert('Error deleting feedback: ' + response.message);
              }
            } catch (error) {
              console.error('Error parsing response:', error);
              alert('Error deleting feedback. Please try again.');
            }
          } else {
            console.error('Error deleting feedback:', xhr.status, xhr.responseText);
            alert('Error deleting feedback. Status: ' + xhr.status);
          }
        };

        xhr.onerror = function() {
          alert('Network error while deleting feedback. Please try again.');
        };

        xhr.send();
      }
    }

    window.addEventListener('focus', function() {
      if (sessionStorage.getItem('isLoggedIn') === 'true' && sessionStorage.getItem('userType') === 'admin') {
        console.log('Window focused, refreshing data...');
        loadAllData();
      }
    });
  </script>
</body>
</html>