<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Requirements - Nadchathra Mahal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            padding: 2rem 0;
        }
        .card {
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: none;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px 20px 0 0 !important;
            border: none;
            padding: 2rem;
        }
        .card-header h1 {
            margin: 0;
            font-weight: 700;
        }
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        .form-control, .form-select {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px 20px;
            font-size: 16px;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            transform: translateY(-1px);
        }
        .form-control.is-valid {
            border-color: #28a745;
        }
        .form-control.is-invalid {
            border-color: #dc3545;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 15px 30px;
            font-weight: 600;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        .btn-primary:disabled {
            opacity: 0.7;
            transform: none;
            box-shadow: none;
        }
        .loading {
            display: none;
        }
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        .alert {
            border-radius: 10px;
            border: none;
            padding: 15px 20px;
            margin: 15px 0;
        }
        .alert-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
        }
        .alert-danger {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
        }
        .section-divider {
            border-top: 2px solid #e9ecef;
            margin: 2rem 0;
            padding-top: 2rem;
        }
        .section-title {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
        }
        .section-title i {
            margin-right: 0.5rem;
            font-size: 1.2em;
        }
        .card-number-display {
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            letter-spacing: 2px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        .admin-link {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .admin-link a {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            padding: 10px 15px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .admin-link a:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <!-- Admin Access Link -->
    <div class="admin-link">
        <a href="/login.html">
            <i class="fas fa-user-shield me-2"></i>Admin Login
        </a>
    </div>

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card">
                    <div class="card-header text-center">
                        <h1><i class="fas fa-castle me-3"></i>Nadchathra Mahal</h1>
                        <p class="mb-0">Event Booking & Payment Portal</p>
                    </div>
                    
                    <div class="card-body p-4">
                        <form id="userRequirementForm">
                            <!-- Personal Information Section -->
                            <div class="section-title">
                                <i class="fas fa-user"></i>
                                Personal Information
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="fullName" class="form-label">
                                        <i class="fas fa-user me-2"></i>Full Name *
                                    </label>
                                    <input type="text" class="form-control" id="fullName" name="fullName" 
                                           placeholder="Enter your full name" required>
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-6">
                                    <label for="email" class="form-label">
                                        <i class="fas fa-envelope me-2"></i>Email Address *
                                    </label>
                                    <input type="email" class="form-control" id="email" name="email" 
                                           placeholder="Enter your email" required>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="phone" class="form-label">
                                        <i class="fas fa-phone me-2"></i>Phone Number *
                                    </label>
                                    <input type="tel" class="form-control" id="phone" name="phone" 
                                           placeholder="Enter your phone number" required>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>

                            <!-- Event Details Section -->
                            <div class="section-divider">
                                <div class="section-title">
                                    <i class="fas fa-calendar-alt"></i>
                                    Event Details
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="eventType" class="form-label">
                                        <i class="fas fa-star me-2"></i>Event Type *
                                    </label>
                                    <select class="form-select" id="eventType" name="eventType" required>
                                        <option value="">Select Event Type</option>
                                        <option value="Wedding">Wedding</option>
                                        <option value="Birthday">Birthday Party</option>
                                        <option value="Conference">Conference</option>
                                        <option value="Corporate">Corporate Event</option>
                                        <option value="Other">Other</option>
                                    </select>
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-6">
                                    <label for="eventDate" class="form-label">
                                        <i class="fas fa-calendar-check me-2"></i>Event Date *
                                    </label>
                                    <input type="date" class="form-control" id="eventDate" name="eventDate" required>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="guestCount" class="form-label">
                                        <i class="fas fa-users me-2"></i>Number of Guests *
                                    </label>
                                    <input type="number" class="form-control" id="guestCount" name="guestCount" 
                                           min="1" max="1000" placeholder="Enter number of guests" required>
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-6">
                                    <label for="budget" class="form-label">
                                        <i class="fas fa-rupee-sign me-2"></i>Budget Range *
                                    </label>
                                    <select class="form-select" id="budget" name="budget" required>
                                        <option value="">Select Budget Range</option>
                                        <option value="Under LKR 100,000">Under LKR 100,000</option>
                                        <option value="LKR 100,000 - 200,000">LKR 100,000 - 200,000</option>
                                        <option value="LKR 200,000 - 500,000">LKR 200,000 - 500,000</option>
                                        <option value="LKR 500,000 - 1,000,000">LKR 500,000 - 1,000,000</option>
                                        <option value="LKR 1,000,000 - 2,000,000">LKR 1,000,000 - 2,000,000</option>
                                        <option value="Over LKR 2,000,000">Over LKR 2,000,000</option>
                                    </select>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>

                            <!-- Special Requirements Section -->
                            <div class="section-divider">
                                <div class="section-title">
                                    <i class="fas fa-clipboard-list"></i>
                                    Special Requirements
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="specialRequirements" class="form-label">
                                    <i class="fas fa-notes-medical me-2"></i>Special Requirements
                                </label>
                                <textarea class="form-control" id="specialRequirements" name="specialRequirements" 
                                          rows="4" placeholder="Any special dietary requirements, accessibility needs, or other requests..."></textarea>
                            </div>

                            <!-- Food Menu Selection Section -->
                            <div class="section-divider">
                                <div class="section-title">
                                    <i class="fas fa-utensils"></i>
                                    Food Menu Selection
                                </div>
                            </div>
                            
                            <!-- Standard Menu Items -->
                            <div class="mb-4">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-list me-2"></i>Standard Menu Items (Please select one option from each category)
                                </h6>
                                
                                <!-- Rice Selection -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">1. Rice Selection *</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="riceType" id="basmathiRice" value="basmathi rice" required>
                                                <label class="form-check-label" for="basmathiRice">Basmathi Rice</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="riceType" id="normalRice" value="normal rice" required>
                                                <label class="form-check-label" for="normalRice">Normal Rice</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Dhal Curry -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">2. Dhal Curry *</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="dhalCurry" id="dhalCurry" value="dhal curry" required>
                                        <label class="form-check-label" for="dhalCurry">Dhal Curry</label>
                                    </div>
                                </div>

                                <!-- Potato Curry -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">3. Potato Curry *</label>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="potatoCurry" id="potatoCurry" value="potato curry" required>
                                                <label class="form-check-label" for="potatoCurry">Potato Curry</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="potatoCurry" id="potatoTomatoCurry" value="potato+tomato curry" required>
                                                <label class="form-check-label" for="potatoTomatoCurry">Potato + Tomato Curry</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="potatoCurry" id="potatoSmashed" value="potato smashed" required>
                                                <label class="form-check-label" for="potatoSmashed">Potato Smashed</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Brinjal Curry -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">4. Brinjal Curry *</label>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="brinjalCurry" id="brinjalCurry" value="brinjal curry" required>
                                                <label class="form-check-label" for="brinjalCurry">Brinjal Curry</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="brinjalCurry" id="friedBrinjalCurry" value="fried brinjal curry" required>
                                                <label class="form-check-label" for="friedBrinjalCurry">Fried Brinjal Curry</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="brinjalCurry" id="friedBrinjalLadiesFinger" value="fried brinjal + ladies finger curry" required>
                                                <label class="form-check-label" for="friedBrinjalLadiesFinger">Fried Brinjal + Ladies Finger Curry</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Appalam & Milaka Poriyal -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">5. Appalam & Milaka Poriyal *</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="appalamMilaka" id="appalamMilaka" value="appalam, milaka poriyal" required>
                                        <label class="form-check-label" for="appalamMilaka">Appalam, Milaka Poriyal</label>
                                    </div>
                                </div>

                                <!-- Vada -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">6. Vada *</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="vada" id="vada" value="vada" required>
                                        <label class="form-check-label" for="vada">Vada</label>
                                    </div>
                                </div>

                                <!-- Paayasam -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">7. Paayasam *</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="paayasam" id="paayasam" value="paayasam" required>
                                        <label class="form-check-label" for="paayasam">Paayasam</label>
                                    </div>
                                </div>

                                <!-- Ice Cream / Fruit Salad -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">8. Dessert *</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="dessert" id="iceCream" value="ice cream" required>
                                                <label class="form-check-label" for="iceCream">Ice Cream</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="dessert" id="fruitSalad" value="fruit salad" required>
                                                <label class="form-check-label" for="fruitSalad">Fruit Salad</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Optional Premium Items -->
                            <div class="mb-4">
                                <h6 class="text-success mb-3">
                                    <i class="fas fa-star me-2"></i>Optional Premium Items (Additional charges apply)
                                </h6>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="premiumItems" id="paneerCurry" value="paneer curry (200/per person)">
                                            <label class="form-check-label" for="paneerCurry">
                                                <strong>Paneer Curry</strong> - ₹200 per person
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="premiumItems" id="chickenCurry" value="chicken curry (250/per person)">
                                            <label class="form-check-label" for="chickenCurry">
                                                <strong>Chicken Curry</strong> - ₹250 per person
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="premiumItems" id="muttonCurry" value="mutton curry (300/per person)">
                                            <label class="form-check-label" for="muttonCurry">
                                                <strong>Mutton Curry</strong> - ₹300 per person
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="premiumItems" id="prawnCurry" value="prawn curry (250/per person)">
                                            <label class="form-check-label" for="prawnCurry">
                                                <strong>Prawn Curry</strong> - ₹250 per person
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Food Notes -->
                            <div class="mb-3">
                                <label for="foodNotes" class="form-label">
                                    <i class="fas fa-sticky-note me-2"></i>Additional Food Notes
                                </label>
                                <textarea class="form-control" id="foodNotes" name="foodNotes" 
                                          rows="3" placeholder="Any specific dietary requirements, allergies, or special food requests..."></textarea>
                            </div>

                            <!-- Summary Section -->
                            <div class="section-divider">
                                <div class="section-title">
                                    <i class="fas fa-receipt"></i>
                                    Event Request Summary
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="fas fa-info-circle me-2"></i>Event Details
                                            </h6>
                                            <p class="card-text small mb-1">
                                                <strong>Type:</strong> <span id="summaryEventType">-</span>
                                            </p>
                                            <p class="card-text small mb-1">
                                                <strong>Date:</strong> <span id="summaryEventDate">-</span>
                                            </p>
                                            <p class="card-text small mb-1">
                                                <strong>Guests:</strong> <span id="summaryGuestCount">-</span>
                                            </p>
                                            <p class="card-text small mb-0">
                                                <strong>Budget:</strong> <span id="summaryBudget">-</span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="fas fa-utensils me-2"></i>Food Preferences
                                            </h6>
                                            <p class="card-text small mb-1">
                                                <strong>Standard Menu:</strong> <span id="summaryCuisine">-</span>
                                            </p>
                                            <p class="card-text small mb-1">
                                                <strong>Premium Items:</strong> <span id="summaryMealType">-</span>
                                            </p>
                                            <p class="card-text small mb-1">
                                                <strong>Food Notes:</strong> <span id="summaryDietary">-</span>
                                            </p>
                                            <p class="card-text small mb-0">
                                                <strong>Status:</strong> <span class="text-warning">Pending Admin Review</span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="alertContainer"></div>

                            <div class="text-center mt-4">
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                    <span class="submit-text">
                                        <i class="fas fa-paper-plane me-2"></i>Submit Event Request
                                    </span>
                                    <span class="loading">
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        Submitting...
                                    </span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class UserRequirementManager {
            constructor() {
                this.form = document.getElementById('userRequirementForm');
                this.submitBtn = document.getElementById('submitBtn');
                this.alertContainer = document.getElementById('alertContainer');
                this.isSubmitting = false;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupRealTimeValidation();
                this.setupInputFormatting();
                console.log('User Requirement Manager initialized');
            }

            setupEventListeners() {
                this.form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSubmit();
                });

                // Real-time summary updates
                const summaryFields = ['eventType', 'eventDate', 'guestCount', 'budget'];
                summaryFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.addEventListener('input', () => this.updateSummary());
                        field.addEventListener('change', () => this.updateSummary());
                    }
                });
                
                // Add listeners for all form inputs including new food menu
                const allInputs = document.querySelectorAll('input, select, textarea');
                allInputs.forEach(input => {
                    input.addEventListener('change', () => this.updateSummary());
                });
            }

            setupRealTimeValidation() {
                const inputs = this.form.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.addEventListener('blur', () => this.validateField(input));
                    input.addEventListener('input', () => {
                        if (input.classList.contains('is-invalid')) {
                            this.validateField(input);
                        }
                    });
                });
            }

            setupInputFormatting() {
                // Card number formatting
                const cardNumber = document.getElementById('cardNumber');
                cardNumber.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                    if (formattedValue.length <= 19) {
                        e.target.value = formattedValue;
                        this.updateSummary();
                    }
                });

                // CVV formatting
                const cvv = document.getElementById('cvv');
                cvv.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                });

                // Expiry year formatting
                const expiryYear = document.getElementById('expiryYear');
                expiryYear.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                });

                // Phone formatting
                const phone = document.getElementById('phone');
                phone.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/[^0-9]/g, '');
                    if (value.length >= 10) {
                        value = value.substring(0, 10);
                    }
                    e.target.value = value;
                });
            }

            validateField(field) {
                const value = field.value.trim();
                let isValid = true;
                let errorMessage = '';

                // Required field validation
                if (field.hasAttribute('required') && !value) {
                    isValid = false;
                    errorMessage = 'This field is required.';
                }

                // Specific validations
                if (value && field.id === 'email') {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(value)) {
                        isValid = false;
                        errorMessage = 'Please enter a valid email address.';
                    }
                }

                if (value && field.id === 'phone') {
                    const phoneRegex = /^\d{10}$/;
                    if (!phoneRegex.test(value)) {
                        isValid = false;
                        errorMessage = 'Please enter a valid 10-digit phone number.';
                    }
                }

                if (value && field.id === 'cardNumber') {
                    const cardNumber = value.replace(/\s/g, '');
                    if (!/^\d{16}$/.test(cardNumber)) {
                        isValid = false;
                        errorMessage = 'Card number must be 16 digits.';
                    }
                }

                if (value && field.id === 'cvv') {
                    if (!/^\d{3}$/.test(value)) {
                        isValid = false;
                        errorMessage = 'CVV must be 3 digits.';
                    }
                }

                if (value && field.id === 'expiryYear') {
                    if (!/^\d{2}$/.test(value)) {
                        isValid = false;
                        errorMessage = 'Expiry year must be 2 digits.';
                    }
                }

                if (value && field.id === 'guestCount') {
                    const count = parseInt(value);
                    if (isNaN(count) || count < 1 || count > 1000) {
                        isValid = false;
                        errorMessage = 'Guest count must be between 1 and 1000.';
                    }
                }

                // Update field appearance
                field.classList.remove('is-valid', 'is-invalid');
                const feedback = field.parentNode.querySelector('.invalid-feedback');
                
                if (!isValid) {
                    field.classList.add('is-invalid');
                    if (feedback) feedback.textContent = errorMessage;
                } else if (value) {
                    field.classList.add('is-valid');
                }

                return isValid;
            }

            updateSummary() {
                document.getElementById('summaryEventType').textContent = 
                    document.getElementById('eventType').value || '-';
                document.getElementById('summaryEventDate').textContent = 
                    document.getElementById('eventDate').value || '-';
                document.getElementById('summaryGuestCount').textContent = 
                    document.getElementById('guestCount').value || '-';
                document.getElementById('summaryBudget').textContent = 
                    document.getElementById('budget').value || '-';
                
                // Get selected food menu items
                const selectedMenu = this.getSelectedFoodMenu();
                document.getElementById('summaryCuisine').textContent = selectedMenu.standard || 'Not selected';
                document.getElementById('summaryMealType').textContent = selectedMenu.premium || 'None';
                document.getElementById('summaryDietary').textContent = selectedMenu.notes || 'None';
            }

            getSelectedFoodMenu() {
                // Get standard menu selections
                const standardItems = [];
                const standardFields = ['riceType', 'dhalCurry', 'potatoCurry', 'brinjalCurry', 'appalamMilaka', 'vada', 'paayasam', 'dessert'];
                
                standardFields.forEach(fieldName => {
                    const selected = document.querySelector(`input[name="${fieldName}"]:checked`);
                    if (selected) {
                        standardItems.push(selected.value);
                    }
                });

                // Get premium items
                const premiumCheckboxes = document.querySelectorAll('input[name="premiumItems"]:checked');
                const premiumItems = Array.from(premiumCheckboxes).map(cb => cb.value);

                // Get food notes
                const foodNotes = document.getElementById('foodNotes').value;

                return {
                    standard: standardItems.length > 0 ? standardItems.join(', ') : 'Not selected',
                    premium: premiumItems.length > 0 ? premiumItems.join(', ') : 'None',
                    notes: foodNotes || 'None'
                };
            }

            maskCardNumber(cardNumber) {
                const cleaned = cardNumber.replace(/\s/g, '');
                if (cleaned.length >= 4) {
                    return '**** **** **** ' + cleaned.slice(-4);
                }
                return cardNumber;
            }

            handleSubmit() {
                if (this.isSubmitting) return;

                // Validate all fields
                const inputs = this.form.querySelectorAll('input[required], select[required]');
                let allValid = true;

                inputs.forEach(input => {
                    if (!this.validateField(input)) {
                        allValid = false;
                    }
                });

                if (!allValid) {
                    this.showAlert('Please fix all validation errors before submitting.', 'danger');
                    return;
                }

                this.setLoading(true);
                this.clearAlerts();

                // Collect form data
                const formData = new FormData(this.form);
                const data = Object.fromEntries(formData.entries());

                // Collect food menu selections
                const foodMenu = this.getSelectedFoodMenu();
                const premiumItems = Array.from(document.querySelectorAll('input[name="premiumItems"]:checked')).map(cb => cb.value);

                console.log('Submitting event request:', data);
                console.log('Food menu selections:', foodMenu);
                console.log('Premium items:', premiumItems);

                // Submit to backend
                this.submitToBackend(data, foodMenu, premiumItems);
            }

            submitToBackend(data, foodMenu, premiumItems) {
                // Save event request to database
                this.saveEventRequest(data, foodMenu, premiumItems);
            }

            saveEventRequest(data, foodMenu, premiumItems) {
                // Prepare event request data for database
                const eventRequestData = {
                    userId: parseInt(sessionStorage.getItem('userId')) || 2, // Get user ID from session
                    fullName: data.fullName,
                    email: data.email,
                    phone: data.phone,
                    eventType: data.eventType,
                    eventDate: data.eventDate,
                    guestCount: parseInt(data.guestCount),
                    budget: data.budget,
                    specialRequirements: data.specialRequirements,
                    // Food menu selections - combine all selections into dietary_restrictions
                    cuisineType: 'Traditional South Indian', // Fixed cuisine type
                    mealType: 'Lunch', // Fixed meal type
                    dietaryRestrictions: foodMenu.standard, // Standard menu items
                    beveragePreferences: foodMenu.premium, // Premium items
                    foodNotes: foodMenu.notes, // Additional notes
                    // Set default values for required fields (will be filled during approval)
                    cardNumber: '0000000000000000',
                    expiryMonth: '01',
                    expiryYear: '25',
                    cvv: '000',
                    cardHolderName: data.fullName
                };

                console.log('Saving event request:', eventRequestData);

                // Save event request to database
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/api/user-requirements', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('Accept', 'application/json');

                xhr.onload = () => {
                    console.log('Event Request XHR Response status:', xhr.status);
                    console.log('Event Request XHR Response text:', xhr.responseText);

                    let eventRequestResponse;
                    try {
                        eventRequestResponse = JSON.parse(xhr.responseText);
                    } catch (error) {
                        console.error('JSON parsing error:', error);
                        this.setLoading(false);
                        this.showAlert('Server response error. Please try again.', 'danger');
                        return;
                    }

                    if (xhr.status >= 200 && xhr.status < 300 && eventRequestResponse.status === 'SUCCESS') {
                        // Event request saved successfully
                        this.handleSuccess(eventRequestResponse, data);
                    } else {
                        this.setLoading(false);
                        this.showAlert('Failed to save event request: ' + (eventRequestResponse.message || 'Unknown error'), 'danger');
                    }
                };

                xhr.onerror = () => {
                    this.setLoading(false);
                    console.error('Event Request XHR Network error');
                    this.showAlert('Network error. Please check your connection and try again.', 'danger');
                };

                xhr.send(JSON.stringify(eventRequestData));
            }

            processPayment(paymentData, fullData, userRequirementId) {
                // Use XMLHttpRequest for better compatibility
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/api/payments/validate', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('Accept', 'application/json');

                xhr.onload = () => {
                    this.setLoading(false);
                    console.log('Payment XHR Response status:', xhr.status);
                    console.log('Payment XHR Response text:', xhr.responseText);

                    let responseData;
                    try {
                        responseData = JSON.parse(xhr.responseText);
                    } catch (error) {
                        console.error('JSON parsing error:', error);
                        this.showAlert('Server response error. Please try again.', 'danger');
                        return;
                    }

                    if (xhr.status >= 200 && xhr.status < 300 && responseData.status === 'COMPLETED') {
                        // Update user requirement with payment status
                        this.updateUserRequirementPaymentStatus(userRequirementId, responseData);
                        this.handleSuccess(responseData, fullData);
                    } else {
                        this.handleError(responseData);
                    }
                };

                xhr.onerror = () => {
                    this.setLoading(false);
                    console.error('Payment XHR Network error');
                    this.showAlert('Network error. Please check your connection and try again.', 'danger');
                };

                xhr.send(JSON.stringify(paymentData));
            }

            updateUserRequirementPaymentStatus(userRequirementId, paymentResponse) {
                // Update user requirement with payment status and transaction ID
                const xhr = new XMLHttpRequest();
                xhr.open('PUT', `/api/user-requirements/${userRequirementId}/payment-status?paymentStatus=COMPLETED&transactionId=${paymentResponse.transactionId}`, true);
                xhr.setRequestHeader('Accept', 'application/json');

                xhr.onload = () => {
                    console.log('Payment Status Update Response:', xhr.status, xhr.responseText);
                };

                xhr.onerror = () => {
                    console.error('Failed to update payment status for user requirement');
                };

                xhr.send();
            }

            handleSuccess(responseData, fullData) {
                console.log('Event request submitted successfully:', responseData);

                this.showAlert(`
                    <h5 class="text-success mb-3">
                        <i class="fas fa-check-circle me-2"></i>Event Request Submitted Successfully!
                    </h5>
                    <p><strong>Name:</strong> ${fullData.fullName}</p>
                    <p><strong>Event:</strong> ${fullData.eventType}</p>
                    <p><strong>Date:</strong> ${fullData.eventDate}</p>
                    <p><strong>Guests:</strong> ${fullData.guestCount}</p>
                    <p><strong>Cuisine:</strong> ${fullData.cuisineType}</p>
                    <p><strong>Meal Type:</strong> ${fullData.mealType}</p>
                    <hr>
                    <p class="text-muted">Your event request has been submitted for admin review. 
                    Our team will review your requirements and contact you within 24 hours to confirm the event details and discuss pricing in Sri Lankan Rupees (LKR).</p>
                    <div class="mt-3">
                        <a href="/user-dashboard.html" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                        </a>
                        <a href="/login.html" class="btn btn-outline-secondary btn-sm ms-2">
                            <i class="fas fa-user-shield me-1"></i>Admin Login
                        </a>
                    </div>
                `, 'success');

                // Reset form after successful submission
                setTimeout(() => {
                    this.form.reset();
                    this.updateSummary();
                }, 3000);
            }

            handleError(responseData) {
                console.error('Submission failed:', responseData);
                this.showAlert(`Submission failed: ${responseData.message || 'Unknown error occurred.'}`, 'danger');
            }

            setLoading(loading) {
                this.isSubmitting = loading;
                this.submitBtn.disabled = loading;
                
                const submitText = this.submitBtn.querySelector('.submit-text');
                const loadingSpinner = this.submitBtn.querySelector('.loading');
                
                if (loading) {
                    submitText.style.display = 'none';
                    loadingSpinner.style.display = 'inline';
                } else {
                    submitText.style.display = 'inline';
                    loadingSpinner.style.display = 'none';
                }
            }

            showAlert(message, type) {
                this.clearAlerts();
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.innerHTML = message;
                this.alertContainer.appendChild(alert);
                
                // Scroll to alert
                alert.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            clearAlerts() {
                this.alertContainer.innerHTML = '';
            }
        }

        // Check user authentication
        function checkUserAuthentication() {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
            const userType = sessionStorage.getItem('userType');
            
            if (!isLoggedIn || userType !== 'user') {
                alert('Access denied. Please login first.');
                window.location.href = '/login.html';
                return false;
            }
            
            return true;
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('User Requirement page loaded, checking authentication...');
            
            // Check authentication first
            if (checkUserAuthentication()) {
                console.log('Authentication successful, initializing manager...');
                new UserRequirementManager();
                console.log('User Requirement page loaded successfully');
            }
        });
    </script>
</body>
</html>
